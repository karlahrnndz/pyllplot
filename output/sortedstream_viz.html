<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3 Area Plot with Labels</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap">
  <style>
    body, .axis text, .label {
      font-family: 'Source Code Pro', monospace;
    }
  </style>
</head>
<body>

<!-- Load data from JSON file -->
<script>
  d3.json('sortedstream_data.json').then(function(data) {
    // Set up SVG container
    var margin = { top: 20, right: 120, bottom: 30, left: 50 }; // Increased right margin for legend
    var width = 600 - margin.left - margin.right;
    var height = 400 - margin.top - margin.bottom;

    var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Create scales
    var xScale = d3.scaleLinear().domain([d3.min(data, function(d) { return d.x; }), d3.max(data, function(d) { return d.x; })]).range([0, width]);
    var yScale = d3.scaleLinear().domain([0, d3.max(data, function(d) { return d.ub; })]).range([height, 0]);

    // Add axes
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(xScale));

    svg.append("g")
      .call(d3.axisLeft(yScale));

    // Add gridlines for the x-axis
    svg.append("g")
      .attr("class", "grid")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(""));

    // Add gridlines for the y-axis
    svg.append("g")
      .attr("class", "grid")
      .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(""));

    // Define custom color palette
    var customColors = ['#283250', '#b33236', '#d5403e', '#eb5140'];
    var colorScale = d3.scaleOrdinal().range(customColors);

    // Define area function with cardinal interpolation
    var area = d3.area()
      .curve(d3.curveMonotoneX)
      .x(function(d) { return xScale(d.x); })
      .y0(function(d) { return yScale(d.lb); })
      .y1(function(d) { return yScale(d.ub); });

    // Draw area plots
    var labels = d3.nest()
      .key(function(d) { return d.label; })
      .entries(data);

    labels.forEach(function(label) {
      svg.append("path")
        .data([label.values])
        .attr("class", "area")
        .attr("d", area)
        .style("fill", function() { return getColorWithOpacity(colorScale(label.key), 0.8); });

      // Add labels on top of the areas
      var labelData = label.values[label.values.length - 1];
      svg.append("text")
        .attr("class", "label")
        .attr("x", xScale(labelData.x) + 10)
        .attr("y", yScale((labelData.ub - labelData.lb) / 2 + labelData.lb))
        .style("text-anchor", "middle")
        .style("fill", "black")
        .text(label.key);
    });

    // Function to get color with opacity
    function getColorWithOpacity(color, opacity) {
      return `rgba(${d3.color(color).r}, ${d3.color(color).g}, ${d3.color(color).b}, ${opacity})`;
    }
  });
</script>

</body>
</html>